{{- $architecture := or .architecture "arm64" -}}
{{- $basename := or .basename "." -}}

architecture: {{ $architecture }}

actions:
  - action: debootstrap
    suite: stretch
    components:
      - main
    mirror: http://deb.debian.org/debian
    variant: minbase

  - action: apt
    recommends: false
    packages:
      - udev
      - kmod
      - systemd-sysv
      - diffutils
#      - python

#      - openssh-server
#      - adduser
#      - libnss-myhostname
#      - libnss-resolve

#      - wget

  - action: run
    description: Set hostname
    chroot: true
    command: echo debian > /etc/hostname

  - action: run
    description: Remove root password
    chroot: true
    command: passwd root -d

  - action: overlay
    source: overlays/networkd

  - action: run
    chroot: true
    script: scripts/setup-networking.sh

  - action: run
    description: Change root shell to sh as bash will be dropped
    chroot: true
    command: chsh -s /bin/sh

  - action: overlay
    source: overlays/minimal

  - action: run
    description: Drop legacy /var/lib/dbus/machine-id generation
    chroot: true
    command: rm /usr/lib/tmpfiles.d/dbus.conf

  - action: run
    chroot: true
    script: scripts/strip.sh

  - action: run
    chroot: true
    script: scripts/crush.sh

  - action: run
    description: Set symbolic link to init
    chroot: true
    command: ln -s /usr/bin/systemd /init

  - action: run
    description: Create cpio archive
    chroot: false
    command: cd ${ROOTDIR} ; find -H  |  cpio -H newc -v -o | gzip -c - > ${ARTIFACTDIR}/{{ $basename -}}/rootfs.cpio.gz

